name: Deploy to Kubernetes

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: crretoxmas2024.azurecr.io
  NAMESPACE: reto-xmas-2025-goland-ia-backend
  ROLLOUT_TIMEOUT: 300
  READY_CHECK_INTERVAL: 10

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: docs-manager
            path: ./DocsManager
            image: reto-xmas-2025-goland-ia-backend-docs-manager
            deployment: docs-manager
          - name: rag-manager
            path: ./RAGManager
            image: reto-xmas-2025-goland-ia-backend-rag-manager
            deployment: rag-manager

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ matrix.service.image }}:latest
            ${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ matrix.service.image }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ matrix.service.image }}:buildcache,mode=max
          provenance: false

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Update deployment image
        run: |
          kubectl set image deployment/${{ matrix.service.deployment }} \
            api=${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ github.sha }} \
            -n ${{ env.NAMESPACE }}

      - name: Wait for deployment to be ready (robust)
        run: |
          echo "Waiting for deployment ${matrix.service.deployment} to be ready..."
          END=$((SECONDS+ROLLOUT_TIMEOUT))

          while [ $SECONDS -lt $END ]; do
            DESIRED=$(kubectl get deployment/${{ matrix.service.deployment }} -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.replicas}')
            AVAILABLE=$(kubectl get deployment/${{ matrix.service.deployment }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.availableReplicas}')
            AVAILABLE=${AVAILABLE:-0}

            echo "Available replicas: $AVAILABLE / $DESIRED"

            if [ "$AVAILABLE" = "$DESIRED" ]; then
              echo "Deployment is ready!"
              exit 0
            fi

            sleep $READY_CHECK_INTERVAL
          done

          echo "Deployment did not become ready in time"
          kubectl describe deployment/${{ matrix.service.deployment }} -n ${{ env.NAMESPACE }}
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          exit 1

      - name: Get logs on failure
        if: failure()
        run: |
          echo "=== Deployment ==="
          kubectl describe deployment/${{ matrix.service.deployment }} -n ${{ env.NAMESPACE }}

          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ matrix.service.deployment }} -o wide

          echo "=== Pod Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} \
            -l app=${{ matrix.service.deployment }} \
            --tail=100 \
            --all-containers=true \
            --prefix=true || true

      - name: Deployment Summary
        if: always()
        run: |
          STATUS="${{ job.status }}"

          echo "### Deployment - ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ matrix.service.image }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Pods:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ matrix.service.deployment }} >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: Deployment Success
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: success()
    steps:
      - name: Notify Discord
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"‚úÖ **Deploy exitoso**\\n\\n**Repositorio:** ${{ github.repository }}\\n**Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\\n**Autor:** ${{ github.actor }}\\n\\n[Ver ejecuci√≥n en GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\\n\\nüöÄ Todos los servicios quedaron desplegados correctamente.\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}

  notify-failure:
    name: Deployment Failed
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: failure()
    steps:
      - name: Notify Discord
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"‚ùå **Fall√≥ el deploy**\\n\\n**Repositorio:** ${{ github.repository }}\\n**Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\\n**Autor:** ${{ github.actor }}\\n\\n[Ver ejecuci√≥n en GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\\n\\n‚ö†Ô∏è Al menos un servicio no pudo desplegarse. Revisar logs.\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}